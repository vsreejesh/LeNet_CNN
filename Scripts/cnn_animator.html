<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeNet-1 Minimal Animator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Inter:wght@400;500;600&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #ffffff; 
            color: #0f172a; 
        }
        
        .handwritten { font-family: 'Patrick Hand', cursive; }

        /* Grid Styles - Graph Paper Look */
        .grid-container {
            display: grid;
            gap: 1px;
            background-color: #cbd5e1; /* Light gray lines */
            border: 2px solid #334155; /* Dark border */
            padding: 1px;
            background-image: linear-gradient(#ffffff 1px, transparent 1px), linear-gradient(90deg, #ffffff 1px, transparent 1px);
            background-size: 100% 100%;
        }
        
        .cell {
            background-color: #ffffff;
            transition: background-color 0.1s;
        }

        /* The Kernel (Sliding Window) */
        .kernel-box {
            position: absolute;
            border: 2px solid #2563eb; /* Blue ink */
            background-color: rgba(37, 99, 235, 0.1);
            pointer-events: none;
            transition: all 0.1s linear;
            z-index: 10;
            box-shadow: 2px 2px 0px rgba(37, 99, 235, 0.2);
        }

        /* Active Pixel on Output */
        .pixel-active {
            background-color: #2563eb !important;
        }
        .pixel-history {
            background-color: #e0f2fe !important; /* Very light blue */
        }

        /* Dense Layer Connection Lines */
        .dense-line {
            position: absolute;
            height: 1px;
            background-color: #94a3b8;
            transform-origin: left center;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .dense-line.active {
            background-color: #2563eb;
            height: 2px;
            opacity: 1;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if(className) i.className = className;
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, className]);
            return <span ref={ref} className="inline-flex items-center justify-center" />;
        };

        // --- GRID COMPONENT ---
        const SketchGrid = ({ size, cellSize, label, highlightBox, activePixel, isInput }) => {
            const cells = useMemo(() => {
                return Array.from({ length: size * size }).map((_, i) => {
                    const x = i % size;
                    const y = Math.floor(i / size);
                    
                    let statusClass = "cell";
                    if (!isInput && activePixel) {
                        if (x === activePixel.x && y === activePixel.y) statusClass += " pixel-active";
                        else if (y < activePixel.y || (y === activePixel.y && x < activePixel.x)) statusClass += " pixel-history";
                    }
                    // Visualize some "dummy data" on input for realism
                    else if (isInput && !highlightBox && Math.random() > 0.8) {
                        // statusClass += " bg-slate-100"; // Static noise
                    }

                    return <div key={i} className={statusClass} style={{ width: cellSize, height: cellSize }}></div>;
                });
            }, [size, cellSize, activePixel, isInput]);

            return (
                <div className="flex flex-col items-center gap-2 relative">
                    <div className="text-sm font-bold text-slate-500 font-mono tracking-widest">{label}</div>
                    <div className="relative">
                        <div className="grid-container" style={{ gridTemplateColumns: `repeat(${size}, ${cellSize}px)` }}>
                            {cells}
                        </div>
                        {isInput && highlightBox && (
                            <div 
                                className="kernel-box"
                                style={{
                                    width: `${highlightBox.w * cellSize}px`,
                                    height: `${highlightBox.h * cellSize}px`,
                                    left: `${highlightBox.x * cellSize}px`,
                                    top: `${highlightBox.y * cellSize}px`,
                                    transform: 'translate(2px, 2px)'
                                }}
                            >
                                <div className="absolute -top-5 left-0 text-blue-600 text-[10px] font-bold font-mono">
                                    {highlightBox.w}x{highlightBox.h}
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="text-xs text-slate-400 font-mono">({size}×{size})</div>
                </div>
            );
        };

        // --- DENSE VISUALIZER ---
        const DenseVisualizer = ({ activeIdx }) => {
            // Visualize 16 inputs connecting to 10 outputs
            const inputs = Array.from({length: 16});
            const outputs = Array.from({length: 10});
            
            return (
                <div className="flex justify-between items-center w-full max-w-lg relative h-64 border border-slate-200 rounded-xl p-8 bg-slate-50">
                    
                    {/* Inputs (Flattened 4x4) */}
                    <div className="flex flex-col gap-1 z-10">
                        <span className="text-xs text-slate-400 mb-2 font-mono text-center">Flat (16)</span>
                        {inputs.map((_, i) => (
                            <div key={i} className={`w-3 h-3 rounded-full transition-colors ${i === activeIdx ? 'bg-blue-600 scale-125' : 'bg-slate-300'}`}></div>
                        ))}
                    </div>

                    {/* SVG Connections */}
                    <svg className="absolute inset-0 w-full h-full pointer-events-none">
                        {inputs.map((_, i) => 
                            outputs.map((_, j) => {
                                const isActive = i === activeIdx;
                                // Simple math to approximate positions based on flex layout
                                const y1 = 45 + (i * 16); 
                                const y2 = 60 + (j * 20);
                                return (
                                    <line 
                                        key={`${i}-${j}`}
                                        x1="60" y1={y1 * 0.8 + 20} // Scaling factor visual approx
                                        x2="450" y2={y2 * 0.8 + 20}
                                        stroke={isActive ? "#2563eb" : "#cbd5e1"}
                                        strokeWidth={isActive ? 2 : 1}
                                        className="transition-all duration-75"
                                    />
                                );
                            })
                        )}
                    </svg>

                    {/* Outputs (Classes) */}
                    <div className="flex flex-col gap-1 z-10">
                        <span className="text-xs text-slate-400 mb-2 font-mono text-center">Classes (10)</span>
                        {outputs.map((_, i) => (
                            <div key={i} className="flex items-center gap-2">
                                <div className={`w-4 h-4 border border-slate-400 flex items-center justify-center text-[8px] bg-white`}>{i}</div>
                                <div className="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                                    <div 
                                        className="h-full bg-blue-500 transition-all duration-100" 
                                        style={{ width: activeIdx !== null ? `${Math.random() * 100}%` : '10%' }}
                                    ></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- MATH BOX ---
        const MathWitness = ({ step, inSize, kSize, stride, outSize }) => {
            let content;
            
            if (step.type === 'conv') {
                content = (
                    <>
                        <div className="text-xs text-slate-400 uppercase tracking-widest mb-1">Padding Formula</div>
                        <div className="text-xl font-mono text-slate-700">
                            {inSize} - {kSize} + 1 = <span className="text-blue-600 font-bold">{outSize}</span>
                        </div>
                    </>
                );
            } else if (step.type === 'pool') {
                content = (
                    <>
                        <div className="text-xs text-slate-400 uppercase tracking-widest mb-1">Stride Formula</div>
                        <div className="text-xl font-mono text-slate-700">
                            {inSize} / {stride} = <span className="text-blue-600 font-bold">{outSize}</span>
                        </div>
                    </>
                );
            } else if (step.type === 'dense') {
                content = (
                    <>
                        <div className="text-xs text-slate-400 uppercase tracking-widest mb-1">Matrix Multiply</div>
                        <div className="text-lg font-mono text-slate-700">
                            Input(16) × Weights = Output(10)
                        </div>
                    </>
                );
            }

            return (
                <div className="border-l-4 border-blue-500 pl-4 py-1">
                    {content}
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [tick, setTick] = useState(0);

            const steps = [
                { id: 0, name: '1. Convolution', type: 'conv', in: 28, k: 5, s: 1, out: 24, cellScale: 1 },
                { id: 1, name: '2. Pooling', type: 'pool', in: 24, k: 2, s: 2, out: 12, cellScale: 1.2 },
                { id: 2, name: '3. Convolution', type: 'conv', in: 12, k: 5, s: 1, out: 8, cellScale: 1.5 },
                { id: 3, name: '4. Pooling', type: 'pool', in: 8, k: 2, s: 2, out: 4, cellScale: 2 },
                { id: 4, name: '5. Fully Connected', type: 'dense', in: 4, out: 10 },
                { id: 5, name: '6. Output', type: 'softmax' }
            ];

            const current = steps[activeTab];

            // Animation Loop
            useEffect(() => {
                let interval;
                if (isPlaying) {
                    interval = setInterval(() => {
                        setTick(t => {
                            if (current.type === 'dense') return (t + 1) % 16;
                            if (current.type === 'softmax') return t; // Static for now
                            
                            const max = current.out * current.out;
                            if (t >= max - 1) {
                                setIsPlaying(false);
                                return 0;
                            }
                            return t + 1;
                        });
                    }, current.type === 'dense' ? 100 : 30);
                }
                return () => clearInterval(interval);
            }, [isPlaying, current]);

            // Reset on tab change
            useEffect(() => {
                setIsPlaying(false);
                setTick(0);
            }, [activeTab]);

            // Calc Positions
            const getPos = () => {
                if (current.type === 'dense') return null;
                const ox = tick % current.out;
                const oy = Math.floor(tick / current.out);
                const ix = ox * current.s;
                const iy = oy * current.s;
                return { ix, iy, ox, oy, w: current.k, h: current.k };
            };

            const pos = getPos();

            return (
                <div className="min-h-screen flex flex-col items-center py-10 bg-white">
                    
                    {/* Header */}
                    <h1 className="text-4xl font-bold mb-2 handwritten text-slate-800">LeNet-1 Animator</h1>
                    <p className="text-slate-500 mb-8 font-mono text-sm">Interactive Architecture Walkthrough</p>

                    {/* Navigation Tabs */}
                    <div className="flex flex-wrap justify-center gap-2 mb-12 max-w-4xl px-4">
                        {steps.map((step, idx) => (
                            <button
                                key={idx}
                                onClick={() => setActiveTab(idx)}
                                className={`px-4 py-2 rounded-lg text-sm font-bold border-2 transition-all
                                    ${activeTab === idx 
                                        ? 'border-blue-600 bg-blue-50 text-blue-700 shadow-md transform -translate-y-1' 
                                        : 'border-slate-200 text-slate-400 hover:border-slate-400 hover:text-slate-600'}`}
                            >
                                {step.name}
                            </button>
                        ))}
                    </div>

                    {/* Main Stage */}
                    <div className="w-full max-w-5xl flex flex-col md:flex-row items-center justify-center gap-12 px-4">
                        
                        {/* LEFT SIDE (Input) */}
                        <div className="flex-1 flex justify-end">
                            {current.type === 'softmax' ? (
                                <div className="text-right">
                                    <h3 className="text-xl font-bold text-slate-700">Final Probability</h3>
                                    <p className="text-slate-400 text-sm">Winner takes all</p>
                                </div>
                            ) : current.type === 'dense' ? (
                                <div className="hidden"></div> 
                            ) : (
                                <SketchGrid 
                                    size={current.in} 
                                    cellSize={Math.min(20, 240 / current.in)} 
                                    label="INPUT" 
                                    isInput={true}
                                    highlightBox={pos ? {x: pos.ix, y: pos.iy, w: pos.w, h: pos.h} : null}
                                />
                            )}
                        </div>

                        {/* CENTER (Operator & Math) */}
                        <div className="flex flex-col items-center gap-6 min-w-[200px]">
                            {/* Operator Icon */}
                            <div className="w-16 h-16 rounded-full bg-slate-100 border-2 border-slate-300 flex items-center justify-center text-slate-500">
                                {current.type === 'conv' && <Icon name="x" className="w-8 h-8" />}
                                {current.type === 'pool' && <span className="text-xl font-bold">avg</span>}
                                {current.type === 'dense' && <Icon name="network" className="w-8 h-8" />}
                                {current.type === 'softmax' && <Icon name="trophy" className="w-8 h-8 text-yellow-500" />}
                            </div>

                            {/* Math Logic Box */}
                            {current.type !== 'softmax' && (
                                <MathWitness 
                                    step={current} 
                                    inSize={current.in} 
                                    kSize={current.k} 
                                    stride={current.s} 
                                    outSize={current.out} 
                                />
                            )}

                            {/* Play Control */}
                            {current.type !== 'softmax' && (
                                <button
                                    onClick={() => setIsPlaying(!isPlaying)}
                                    className={`flex items-center gap-2 px-6 py-2 rounded-full font-bold text-white shadow-lg transition-transform hover:scale-105 active:scale-95
                                        ${isPlaying ? 'bg-red-500' : 'bg-blue-600'}`}
                                >
                                    {isPlaying ? 'PAUSE' : 'PLAY'}
                                </button>
                            )}
                        </div>

                        {/* RIGHT SIDE (Output) */}
                        <div className="flex-1 flex justify-start">
                            {current.type === 'dense' ? (
                                <div className="-ml-24"> {/* Shift left to center the wide visualization */}
                                    <DenseVisualizer activeIdx={isPlaying ? tick : null} />
                                </div>
                            ) : current.type === 'softmax' ? (
                                <div className="bg-white border-2 border-slate-200 rounded-xl p-6 shadow-xl">
                                    <div className="flex items-end gap-2 h-40">
                                        {[10, 5, 5, 20, 5, 80, 5, 10, 5, 5].map((h, i) => (
                                            <div key={i} className="flex flex-col items-center gap-1">
                                                <div 
                                                    className={`w-6 rounded-t transition-all duration-500 ${i===5 ? 'bg-green-500' : 'bg-slate-200'}`} 
                                                    style={{ height: `${h}%` }}
                                                ></div>
                                                <span className="text-xs font-mono text-slate-400">{i}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="text-center mt-4 font-bold text-green-600">Prediction: 5</div>
                                </div>
                            ) : (
                                <SketchGrid 
                                    size={current.out} 
                                    cellSize={Math.min(20, 240 / current.out)} 
                                    label="OUTPUT" 
                                    isInput={false}
                                    activePixel={pos ? {x: pos.ox, y: pos.oy} : null}
                                />
                            )}
                        </div>

                    </div>

                    {/* Footer Explanation */}
                    <div className="mt-16 max-w-2xl text-center bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-yellow-800 text-sm">
                        <strong className="block mb-1 uppercase tracking-wide text-xs">Instructor Note</strong>
                        {current.type === 'conv' && "Notice how the blue box (Kernel) slides. It stops before falling off the edge. This 'Valid Padding' is exactly why the image shrinks!"}
                        {current.type === 'pool' && "Here, the blue box jumps (Stride 2). It takes 4 pixels and turns them into 1 average pixel. This shrinks the image by half."}
                        {current.type === 'dense' && "We flatten the final grid into a line. Then, every single pixel connects to every output class (0-9)."}
                        {current.type === 'softmax' && "The tallest bar wins. This is the Softmax function turning scores into a probability."}
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>